#!/bin/bash
# ONE-LINE DEPLOYMENT FOR KADAIPOS
# Copy everything below and paste into: ssh root@72.60.76.34

set -e && apt-get update -y && apt-get upgrade -y && apt-get install -y curl git nginx build-essential && (command -v node > /dev/null || (curl -sL https://deb.nodesource.com/setup_18.x | bash - && apt-get install -y nodejs)) && npm install -g pm2 2>/dev/null || true && mkdir -p /var/www/kadaipos.id && cd /var/www && ([ -d kadaipos.id ] || git clone https://github.com/gemmyadyendra/kadaipos.id.git) && cd /var/www/kadaipos.id && git pull origin main --force && npm install --production && npm run build && pm2 delete kadaipos 2>/dev/null || true && pm2 start npm --name kadaipos -- start -- --hostname 127.0.0.1 --port 3000 && pm2 save && pm2 startup -u root --hp /root > /dev/null 2>&1 || true && cat > /etc/nginx/sites-available/kadaipos.id << 'NGINX' && server { listen 80 default_server; server_name _; location / { proxy_pass http://127.0.0.1:3000; proxy_http_version 1.1; proxy_set_header Upgrade $http_upgrade; proxy_set_header Connection 'upgrade'; proxy_set_header Host $host; proxy_set_header X-Real-IP $remote_addr; proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for; proxy_set_header X-Forwarded-Proto $scheme; proxy_cache_bypass $http_upgrade; } location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2)$ { expires 1y; add_header Cache-Control "public, immutable"; } } NGINX && ln -sf /etc/nginx/sites-available/kadaipos.id /etc/nginx/sites-enabled/kadaipos.id && rm -f /etc/nginx/sites-enabled/default && nginx -t && systemctl reload nginx && mkdir -p /var/log && cat > /usr/local/bin/kadaipos-health-check << 'HEALTH' && #!/bin/bash && if curl -s http://127.0.0.1:3000 > /dev/null 2>&1; then echo "[$(date)]  ✅" >> /var/log/kadaipos-health-check.log; exit 0; fi && pm2 list | grep -q kadaipos && pm2 restart kadaipos || pm2 start npm --name kadaipos -- start -- --hostname 127.0.0.1 --port 3000 && sleep 3 && if ! curl -s http://127.0.0.1:3000 > /dev/null 2>&1; then cd /var/www/kadaipos.id && git pull origin main --force && npm install --production && npm run build && pm2 restart kadaipos; fi HEALTH && chmod +x /usr/local/bin/kadaipos-health-check && (crontab -l 2>/dev/null | grep -v kadaipos-health-check; echo "*/5 * * * * /usr/local/bin/kadaipos-health-check >> /var/log/kadaipos-health-check.log 2>&1") | crontab - && sleep 3 && echo "✅ DONE! App at http://72.60.76.34" && pm2 list && echo "Testing..." && curl -s http://127.0.0.1:3000 | head -3
