name: Deploy to VPS

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v3
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan 72.60.76.34 >> ~/.ssh/known_hosts 2>/dev/null
      
      - name: Pull latest code
        run: |
          ssh root@72.60.76.34 "cd /var/www/kadaipos.id && git pull origin main"
      
      - name: Install dependencies
        run: |
          ssh root@72.60.76.34 "cd /var/www/kadaipos.id && npm install --production"
      
      - name: Build
        run: |
          ssh root@72.60.76.34 "cd /var/www/kadaipos.id && npm run build"
      
      - name: Restart app
        run: |
          ssh root@72.60.76.34 "pm2 restart kadaipos"
      
      - name: Health check
        run: |
          for i in {1..5}; do
            if ssh root@72.60.76.34 "curl -f http://localhost:3000" > /dev/null 2>&1; then
              echo "✅ Health check passed"
              exit 0
            fi
            echo "Attempt $i/5..."
            sleep 3
          done
          echo "❌ Health check failed"
          ssh root@72.60.76.34 "pm2 logs kadaipos --lines 20"
          exit 1
      
      - name: Notify success
        if: success()
        run: echo "✅ Deployment successful! App available at http://72.60.76.34"
      
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ Deployment failed!"
          ssh root@72.60.76.34 "pm2 logs kadaipos --lines 50"
          exit 1

